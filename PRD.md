지금까지 논의된 모든 아이디어(타르코프 스타일의 익스트랙션, 판타지 테마, 2D 그리드, 마우스 추적 시야, 은신, 몬스터 AI 등)를 종합하여 개발을 위한 **제품 요구 사항 정의서(PRD, Product Requirements Document)**를 작성해 드립니다.

이 문서는 개발 시 기능 명세서로 활용하실 수 있습니다.

---

# Product Requirements Document (PRD)
## Project Name: Escape from Dungeonkov (Web Edition)

| 항목 | 내용 |
| :--- | :--- |
| **장르** | 2D Top-down PvPvE Extraction RPG (Roguelike) |
| **플랫폼** | Web Browser (PC) |
| **타겟 유저** | 하드코어 생존 게임 선호 유저, 로그라이크 팬 |
| **핵심 경험** | 제한된 시야에서 오는 공포, 파밍의 쾌감, 상실의 리스크 |
| **개발 스택** | Client: Phaser 3 / Server: Node.js (Colyseus) / DB: MongoDB |

---

## 1. 게임 개요 (Game Overview)
**Escape from Dungeonkov**는 랜덤하게 생성되는 어두운 지하 던전에서 몬스터와 다른 플레이어의 위협을 뚫고 유물을 모아 탈출하는 게임이다. 죽으면 모든 것을 잃고, 살아남으면 부자가 된다. 웹 브라우저 기반의 접근성과 하드코어한 심리전이 결합된 게임이다.

---

## 2. 핵심 게임 루프 (Core Loop)
1.  **준비 (Lobby):** 창고에서 장비를 장착하고 던전 입장 버튼 클릭.
2.  **탐험 (In-Game):** 랜덤 던전 스폰 -> 시야를 밝히며 이동 -> 몬스터/상자 파밍.
3.  **조우 (Encounter):** 다른 플레이어의 소리를 듣거나 시야 끝에서 발견 -> 교전 또는 은신/도주.
4.  **탈출 (Extraction):** 제한 시간 내에 랜덤하게 열리는 '탈출 포탈'로 이동하여 생존.
5.  **정산 (Result):** 획득한 전리품을 창고에 저장하거나 상점에 판매하여 더 강한 장비 구매.

---

## 3. 상세 시스템 명세 (System Specifications)

### 3.1 시야 및 가시성 시스템 (Vision & Visibility) **[핵심]**
이 게임의 가장 중요한 차별화 요소로, 보이지 않는 곳에 대한 공포를 조성한다.

*   **마우스 추적 시야 (Cone of Vision):**
    *   캐릭터는 항상 마우스 커서 방향을 바라본다.
    *   캐릭터 전방 기준 **90도~120도 부채꼴 영역**만 밝게 보인다(Flashlight 효과).
    *   플레이어의 등 뒤는 암흑(Fog) 상태이며, 적이 접근해도 보이지 않는다.
*   **레이캐스팅 (Raycasting):**
    *   시야 범위 내라도 **벽(Wall)**이나 장애물이 있으면 그 뒤쪽은 그림자가 되어 보이지 않는다.
    *   `phaser-raycaster` 플러그인 등을 활용하여 실시간 연산.
*   **서버 사이드 필터링 (Anti-Cheat):**
    *   클라이언트 변조(맵핵) 방지를 위해, 서버는 **플레이어 시야 밖의 적(Enemy) 위치 데이터를 클라이언트로 전송하지 않는다.**

### 3.2 은신 및 환경 상호작용 (Stealth & Environment)
*   **수풀 (Bush):**
    *   **진입 시:** 플레이어 본인에게는 반투명(Alpha 0.5)하게 보임.
    *   **외부 관찰자:** 수풀 내부의 플레이어가 아예 렌더링되지 않음(Invisible).
    *   **동시 진입:** 적과 내가 같은 수풀 타일에 있으면 서로 보임.
    *   **패널티:** 수풀 안에서 공격하거나 피격당하면 은신 해제.
*   **소음 시각화 (Sound Visualization):**
    *   행동(걷기, 뛰기, 공격, 파밍) 시 캐릭터 중심으로 **하얀색 파동(Wave)**이 퍼져나감.
    *   파동이 벽 너머 적에게 닿으면, 적 화면에 붉은색 진동 마커 표시.
    *   **Shift 이동:** 소음 파동이 발생하지 않으나 이동 속도 50% 감소.

### 3.3 맵 및 던전 생성 (Procedural Generation)
*   **알고리즘:** BSP(Binary Space Partitioning) 또는 Cellular Automata 사용.
*   **구조:** 방(Room)과 복도(Corridor)로 구성된 미로 형태.
*   **배치:**
    *   가장자리: 플레이어 스폰 포인트 (10~15명).
    *   중앙: 보스 몬스터 및 고등급 보물 상자.
    *   랜덤: 탈출구(파란색 포탈)는 게임 종료 3분 전부터 무작위 위치 활성화.

### 3.4 전투 및 조작 (Combat & Controls)
*   **이동:** WASD (그리드 스냅 이동).
*   **조준:** 마우스 커서 (캐릭터 회전).
*   **공격:** 마우스 좌클릭.
    *   무기별 히트박스(Grid Hitbox) 상이: 단검(1칸), 창(2칸 관통), 대검(전방 3칸 횡베기).
*   **기습 (Ambush):** 은신 상태(수풀, 등 뒤)에서 가하는 첫 공격은 1.5배 치명타 피해.

---

## 4. 엔티티 및 콘텐츠 (Entities & Content)

### 4.1 플레이어 클래스 (MVP 기준)
| 클래스 | 특성 | 기본 장비 |
| :--- | :--- | :--- |
| **파이터 (Fighter)** | 체력 높음, 이동 보통 | 한손검, 방패 (우클릭 방어 가능) |
| **로그 (Rogue)** | 체력 낮음, 이동 빠름, 은신 보너스 | 단검 (공격 속도 빠름) |
| **메이지 (Mage)** | 체력 매우 낮음, 원거리 공격 | 마법봉 (화염구 - 직선 5칸 발사) |

### 4.2 몬스터 (AI Behaviors)
*   **스켈레톤 (Grunt):** 순찰 모드. 발견 시 직선으로 추격. "달그락" 소음 파동을 주기적으로 발생시킴.
*   **슈리커 (Alarm):** 이동 불가. 플레이어 감지 시 비명을 질러 주변 플레이어에게 위치 노출(광역 소음 파동).
*   **고블린 (Loot):** 플레이어를 보면 반대 방향으로 도망. 처치 시 골드 드랍.
*   **오우거 (Boss):** 체력 높음. 3x3 범위 공격으로 벽이나 수풀을 파괴함.

### 4.3 아이템
*   **장비:** 무기, 갑옷(소음/방어력 트레이드오프).
*   **소모품:** 체력 포션(사용 시간 3초), 붕대, 투명 물약.
*   **전리품:** 고대 주화, 보석, 몬스터 부산물 (상점 판매용).

---

## 5. 기술 아키텍처 (Technical Architecture)

### 5.1 Client (Frontend)
*   **Engine:** Phaser 3 (Canvas/WebGL 렌더링).
*   **Logic:**
    *   입력(Input) 감지 및 서버 전송.
    *   서버 상태(State) 수신 후 보간(Interpolation) 처리하여 부드러운 이동 구현.
    *   `phaser-raycaster`를 이용한 시야 마스킹 렌더링.

### 5.2 Server (Backend)
*   **Framework:** Node.js + **Colyseus** (추천: 상태 동기화 및 방 관리에 최적화).
*   **Role:**
    *   Authoritative Server (모든 로직의 권한은 서버에 있음).
    *   충돌 처리, 데미지 계산, 아이템 획득 판정.
    *   **FOV Filtering:** 각 클라이언트에게 보낼 엔티티 목록을 시야 로직에 따라 필터링(보안).
*   **Frequency:** 20Hz~30Hz (초당 20~30회 업데이트).

### 5.3 Database
*   **MongoDB:** 유저 계정, 창고 인벤토리, 장비 정보 등 영구 데이터 저장.
*   **Redis:** (선택사항) 빠른 매치메이킹 대기열 관리.

---

## 6. UI/UX 디자인

*   **HUD:** 화면 하단 중앙에 체력바(Red)와 경험치/마나바(Blue).
*   **인벤토리:** `I` 키 또는 `Tab` 키로 호출. 그리드(Grid) 방식. 테트리스 형태(아이템별 크기 다름) 권장하나 MVP는 슬롯 방식 가능.
*   **메시지:** 중앙 상단에 킬 로그(Kill Log) 및 탈출구 개방 알림 표시.
*   **스타일:** 어두운 픽셀 아트 테마. UI는 직관적인 아이콘 위주.

---

## 7. 개발 로드맵 (Milestones)

### Phase 1: 프로토타입 (Single Player)
*   Phaser 3 기본 세팅 및 2D 그리드 맵 렌더링.
*   플레이어 이동(WASD) 및 마우스 추적 시야(Raycasting) 구현.
*   수풀 은신 및 벽 충돌 처리.

### Phase 2: 멀티플레이어 연동 (Network)
*   Colyseus 서버 구축.
*   다중 접속 및 캐릭터 동기화.
*   서버 사이드 시야 필터링 적용 (핵심 기술 검증).

### Phase 3: 게임 루프 완성 (Gameplay)
*   몬스터 AI 및 전투 시스템(공격/피격/사망) 구현.
*   아이템 파밍 및 인벤토리 UI 개발.
*   소음 시각화 시스템 적용.

### Phase 4: 메타 게임 (Persistence)
*   DB 연동 (로그인/회원가입).
*   로비, 상점, 창고 시스템 구현.
*   탈출 로직 및 보상 저장 구현.
*   알파 테스트 진행.